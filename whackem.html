<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Whackem</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
var game = new Phaser.Game(800, 600, Phaser.AUTO, 'test', null, false, false);

var BasicGame = function (game) {};

BasicGame.Boot = function (game) {};

var timer, timerEvent, text;
var timeText;
var char1;
var char2;
var char3;
var char4;
var char5;
var char6;
var riser;
var riserY;
var status;
var hitEffects;
var hitAreas;

BasicGame.Boot.prototype = {
    preload: function () {
        game.load.image('background', 'assets/bg.png');
		game.load.image('char', 'assets/char.png');
		game.load.image('hit', 'assets/hit.png');
		game.load.image('hole', 'assets/hole.png');
		game.load.image('curtain', 'assets/curtain.png');
    },
    create: function () {
		game.physics.startSystem(Phaser.Physics.ARCADE);
	
	    //  A simple background for our game
		game.add.sprite(0, 0, 'background');
			
		upperholes = game.add.group();
		upperholes.enableBody = true;

		// Holes 1-3
		hole1 = upperholes.create(100, 270, 'hole');
		hole1.body.immovable = true;
		
		hole2 = upperholes.create(300, 270, 'hole');
		hole2.body.immovable = true;
				
		hole3 = upperholes.create(500, 270, 'hole');
		hole3.body.immovable = true;

		lowerholes = game.add.group();
		lowerholes.enableBody = true;
		
		hole4 = lowerholes.create(100, 485, 'hole');
		hole4.body.immovable = true;
		
		hole5 = lowerholes.create(300, 485, 'hole');
		hole5.body.immovable = true;
		
		hole6 = lowerholes.create(500, 485, 'hole');
		hole6.body.immovable = true;		
		
		//Characters
		upperchars = game.add.group();
		upperchars.enableBody = true;
		
		char1 = upperchars.create(100, 290, 'char');
		char1.body.moves = true;
		char1.inputEnabled = true;
		char1.events.onInputDown.add(this.onClicked, this);
		
		char2 = upperchars.create(300, 290, 'char');
		char2.body.moves = true;
		char2.inputEnabled = true;
		char2.events.onInputDown.add(this.onClicked, this);
		
		char3 = upperchars.create(500, 290, 'char');
		char3.body.moves = true;
		char3.inputEnabled = true;
		char3.events.onInputDown.add(this.onClicked, this);
		
		//'Curtains' that hide the characters
		uppercurtains = game.add.group();
		uppercurtains.enableBody = true;
		
		curtain1 = uppercurtains.create(100, 290, 'curtain');
		curtain1.body.immovable = true;
		
		curtain2 = uppercurtains.create(300, 290, 'curtain');
		curtain2.body.immovable = true;
				
		curtain3 = uppercurtains.create(500, 290, 'curtain');
		curtain3.body.immovable = true;
		
		lowerchars = game.add.group();
		lowerchars.enableBody = true;
		
		char4 = lowerchars.create(100, 505, 'char');
		char4.body.moves = true;
		char4.inputEnabled = true;
		char4.events.onInputDown.add(this.onClicked, this);
		
		char5 = lowerchars.create(300, 505, 'char');
		char5.body.moves = true;
		char5.inputEnabled = true;
		char5.events.onInputDown.add(this.onClicked, this);
		
		char6 = lowerchars.create(500, 505, 'char');
		char6.body.moves = true;
		char6.inputEnabled = true;
		char6.events.onInputDown.add(this.onClicked, this);
			
		lowercurtains = game.add.group();
		lowercurtains.enableBody = true;
		
		curtain4 = lowercurtains.create(100, 505, 'curtain');
		curtain4.body.immovable = true;
		
		curtain5 = lowercurtains.create(300, 505, 'curtain');
		curtain5.body.immovable = true;
		
		curtain6 = lowercurtains.create(500, 505, 'curtain');
		curtain6.body.immovable = true;		
		
		//  The score
		timeText = game.add.text(16, 16, '0', { fontSize: '32px', fill: '#000' });
		
		hitAreas = game.add.group();
		hitAreas.enableBody = true;
		
		hitEffects = game.add.group();
		hitEffects.enableBody = true;
		
		var hitEffect;

		game.input.onTap.add(function(pointer) {
		  hitEffect = hitEffects.create(pointer.position.x - 30.5, pointer.position.y - 30.5, 'hit');
		  hitEffect.body.immovable = true;		  
		  hitEffect.scale.setTo(0.5, 0.5);
		  hitEffect.alpha =  hitEffect.alpha - 0.5;
		  
		  hit = hitAreas.create(pointer.position.x - 15.25, pointer.position.y - 15.25, 'hit');
		  hit.body.immovable = true;		  
		  hit.scale.setTo(0.25, 0.25);
		  hit.alpha =  0;
		});
		
		riser = this.pickChar();
		this.peekChar(riser);
    },
    update: function () {
	    game.physics.arcade.collide(hitAreas, lowerchars, this.onHit);
		//game.physics.arcade.collide(hitAreas, upperchars, this.onHit);
		
		if(Math.round(riser.position.y) <= Math.round((riserY - 130)) && status == 'rising'){
			this.hideChar();
		}
 		else if(Math.round(riser.position.y) == Math.round((riserY)) && status == 'hiding'){
			riser.body.velocity.y = 0;
			riser = this.pickChar();
			this.peekChar(riser);
		}
		
		hitEffects.forEach(function(item) {	
			if(!(typeof item === "undefined")){
				var oldWidth = item.width;
				 
				item.alpha = item.alpha - 0.046;			
				item.scale.setTo(item.scale.x * 1.05, item.scale.y * 1.05);
				item.position.x = item.position.x - ((item.width - oldWidth)/2);
				item.position.y = item.position.y - ((item.width - oldWidth)/2);
				
				if (item.alpha <= 0)
				{
					hitEffects.remove(item);
					item.destroy();
					
					hitAreas.forEach(function(item) {	
						if(!(typeof item === "undefined")){
							hitAreas.remove(item);
							item.destroy();
						}
					});
				}
				
			}			
		});

    },
    render: function () {	
		//timeText.text = riserY + " --- " + riser.position.y;
    },
	pickChar: function() {
		var rand = Math.floor(Math.random() * 6) + 1;
		var charx;
		if(rand ==1){
			charx = char1;
		}else if(rand ==2){
			charx = char2;
		}else if(rand ==3){
			charx = char3;
		}else if(rand ==4){
			charx = char4;
		}else if(rand ==5){
			charx = char5;
		}else if(rand ==6){
			charx = char6;
		}
		riserY = charx.position.y;
		return charx;
	},
	peekChar: function(){
		riser.body.velocity.y = -50;
		status = 'rising';
	},
	hideChar: function(){
		riser.body.velocity.y = 50;
		status = 'hiding';
	},
	onHit: function(hit, charx){

	    hitAreas.forEach(function(item) {	
			if(!(typeof item === "undefined")){
				hitAreas.remove(item);
				item.destroy();
			}
		});		
		
		status = 'hiding';
		charx.body.velocity.y = 50;
		
		timeText.text = parseInt(timeText.text) + 50;
		this.winConCheck();
	},
	onClicked: function(charx){
		hitAreas.forEach(function(item) {	
			if(!(typeof item === "undefined")){
				hitAreas.remove(item);
				item.destroy();
			}
		});		
		
		status = 'hiding';
		charx.body.velocity.y = 50;
		
		timeText.text = parseInt(timeText.text) + 50;
		this.winConCheck();
	},
	winConCheck: function(){
		if(parseInt(timeText.text) >= 150){
			timeText.text = "You win!!!";
			game.paused = true;
		}
	}
};

game.state.add('Boot', BasicGame.Boot);
game.state.start('Boot');

</script>

</body>
</html>