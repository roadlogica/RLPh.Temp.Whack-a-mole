<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Whack-a-mole</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
			padding:0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
function adjust() {	
	var divgame = document.getElementById("game");
	divgame.style.width = window.innerWidth + "px";	divgame.style.height = window.innerHeight + "px";
}

window.addEventListener('resize', function() {
       adjust();
});

var game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, 'test', null, false, false);

var BasicGame = function (game) {};

BasicGame.Boot = function (game) {};

var pts;
var gameSettings;
var timer, timerEvent, text;
var scoreText;
var messageText;
var risers = [];
var hitEffects;
var hitAreas;
var moles;
var board;
var startButton;
var againButton;
var gameActive;
var logo;
var grats;
var gameWidth = window.innerWidth / 750;
var gameHeight = window.innerHeight / 1334;

BasicGame.Boot.prototype = {
    preload: function () {
		this.create = function() {
			console.debug("Setup pointer and scale");
			game.input.maxPointers = 1;
			game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
			game.scale.pageAlignHorizontally = true;
			game.scale.pageAlignVertically = true;
			game.scale.setScreenSize(true);
			game.scale.refresh();
			adjust();
		};
	
		game.load.json('gamesettings', 'assets/gamesettings.json');
		game.load.image('background', 'assets/default/bg_world.png');
		game.load.image('char', 'assets/default/char.png');
		game.load.image('hit', 'assets/default/hit.png');
		game.load.image('hole', 'assets/default/hole.png');
		game.load.image('curtain', 'assets/default/curtain.png');
		game.load.image('again', 'assets/default/btn-play-again.png');
		game.load.image('start', 'assets/default/btn-play-now.png');
		game.load.image('board', 'assets/default/board.png');
		game.load.image('logo', 'assets/logo.png');
		game.load.image('congratulations', 'assets/default/img-congrats.png');
    },
    create: function () {
		game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
		game.scale.setShowAll();

		gameSettings = game.cache.getJSON('gamesettings');
		
		game.physics.startSystem(Phaser.Physics.ARCADE);
	
	    //  A simple background for our game
		var bg = game.add.sprite(0, 0, 'background');
		bg.scale.setTo(gameWidth, gameHeight);	
		

		
		stage = game.add.group();
		stage.enableBody = true;
		moles = game.add.group();
		moles.enableBody = true;
		
		stage.add(moles);
		console.log(gameWidth);
		var holeStartPointX = parseInt(window.innerWidth * 0.12);
		var holeStartPointY = parseInt(window.innerHeight * 0.65);
		var holeSpacingX = parseInt(window.innerWidth / 3.5);
		var holeSpacingY = parseInt(window.innerHeight / 5.1);
		var molePop = parseInt(gameSettings.molePopulation);
		var molePerRow = parseInt(gameSettings.molePerRow);
		var row = 0;
		var inRow = 0;
		
		//Create moles
		for (i = 0; i < (molePop); i++) {
			var yPos = parseInt(holeStartPointY) + (row * parseInt(holeSpacingY)) + 20;
			var xPos = parseInt(holeStartPointX) + ((i >= molePerRow ? (i - (molePerRow)): i) * parseInt(holeSpacingX));
			hole1 = stage.create(xPos, parseInt(holeStartPointY) + (row * parseInt(holeSpacingY)), 'hole');
			hole1.body.immovable = true;
			
			mole = stage.create(xPos, yPos, 'char');
			mole.body.moves = true;
			mole.inputEnabled = true;
			mole.events.onInputDown.add(this.onCharClicked, this);
			mole.input.priorityID = 0 + row;
			mole.status = 'none';
			mole.startPositionX = xPos;	
			mole.startPositionY = yPos;				
			mole.moleNo = i + 1;
		
			curtain1 = stage.create(xPos, parseInt(holeStartPointY) + (row * parseInt(holeSpacingY)) + 20, 'curtain');
			curtain1.body.immovable = true;
			curtain1.inputEnabled = true;
			curtain1.events.onInputDown.add(this.onCurtainClicked, this);
			curtain1.input.priorityID = 1 + row;			
			
			inRow = inRow + 1;
			if(inRow == molePerRow){
				row = row + 1;
				inRow = 0;
			}
		}
		
		//  The score
		scoreText = game.add.text(16, 16, '00', gameSettings.font);
		
		hitAreas = game.add.group();
		hitAreas.enableBody = true;
		
		hitEffects = game.add.group();
		hitEffects.enableBody = true;
		
		var hitEffect;

		game.input.onTap.add(function(pointer) {
		  hitEffect = hitEffects.create(pointer.position.x - 30.5, pointer.position.y - 30.5, 'hit');
		  hitEffect.body.immovable = true;		  
		  hitEffect.scale.setTo(0.5, 0.5);
		  hitEffect.alpha =  hitEffect.alpha - 0.5;
		  
		  hit = hitAreas.create(pointer.position.x - 15.25, pointer.position.y - 15.25, 'hit');
		  hit.body.immovable = true;		  
		  hit.scale.setTo(0.25, 0.25);
		  hit.alpha =  0;
		});
		
		gameActive = false;
		this.showStart();
    },
	showStart: function(){
		gameActive = false;
		board = game.add.sprite(window.innerWidth/7, window.innerHeight / 3.5, 'board');
		
		logo = game.add.sprite(window.innerWidth/6,window.innerHeight / 3, 'logo');
		
		startButton = game.add.sprite(window.innerWidth/3,window.innerHeight / 1.55, 'start');
		startButton.inputEnabled = true;
		startButton.events.onInputDown.add(this.onStart, this);
		startButton.input.priorityID = 1000;
		
		againButton = game.add.sprite(window.innerWidth/3.3,window.innerHeight / 1.55, 'again');
		againButton.inputEnabled = true;
		againButton.events.onInputDown.add(this.onStart, this);
		againButton.input.priorityID = 1000;
		againButton.alpha = 0;
		
		messageText = game.add.text(window.innerWidth/3.7, window.innerHeight / 2, '', gameSettings.font);
	},
	onStart: function(){
		gameActive = false;
		board.alpha = 0;
		startButton.alpha = 0;
		againButton.alpha = 0;
		messageText.alpha = 0;
		if(!(typeof grats === "undefined")){	
		grats.alpha = 0;
		}
		logo.alpha = 0;
		scoreText.text = "00";
		risers = [];
		gameActive = true;
		while(risers.length < parseInt(gameSettings.risers)){
			this.pickChar();
		}
		
	},	
    update: function () {
	    game.physics.arcade.collide(hitAreas, stage, this.onHit);
		var riserIndex;
		if(gameActive == true){			
			stage.forEach(function(riser) {		
				if(!(typeof riser.moleNo === "undefined")){			
					riserIndex = risers.indexOf(riser.moleNo);
					//when riser reaches 100px higher than starting position, begin hide
					if(Math.round(riser.position.y) <= Math.round((riser.startPositionY - 100)) && riser.status == 'rising'){
						riser.body.velocity.y = 50;
						riser.status = 'hiding'; 
					}
					else if(Math.round(riser.position.y) >= Math.round((riser.startPositionY)) && riser.status == 'hiding'){
						riser.body.velocity.y = 0;
						riser.status = 'none';
						risers.splice(riserIndex, 1);
						this.pickChar();
					};
				}
			}, this);	
			hitEffects.forEach(function(item) {	
				if(!(typeof item === "undefined")){
					var oldWidth = item.width;
					 
					item.alpha = item.alpha - 0.046;			
					item.scale.setTo(item.scale.x * 1.05, item.scale.y * 1.05);
					item.position.x = item.position.x - ((item.width - oldWidth)/2);
					item.position.y = item.position.y - ((item.width - oldWidth)/2);
					
					if (item.alpha <= 0)
					{
						hitEffects.remove(item);
						item.destroy();
						
						hitAreas.forEach(function(item) {	
							if(!(typeof item === "undefined")){
								hitAreas.remove(item);
								item.destroy();
							}
						});
					}
					
				}			
			});
		}
    },
    render: function () {	
		//timeText.text = riserY + " --- " + riser.position.y;
    },
	pickChar: function() {
		var rand = Math.floor(Math.random() * 6) + 1;
		var speed = Math.floor(Math.random() * parseInt(gameSettings.moveSpeedMax)) + 71;
		while(risers.indexOf(rand) > -1){
			rand = Math.floor(Math.random() * 6) + 1;
		}
		var charx;
		stage.forEach(function(item) {	
			if(item.moleNo == rand) {  
				charx = item;  
			}
		});
		risers.push(rand);
		charx.body.velocity.y = -1 * speed;
		charx.speed = speed;
		charx.status = 'rising';
		charx.moves = true;
		return charx;
	},
	onCharClicked: function(charx){
		hitAreas.forEach(function(item) {	
			if(!(typeof item === 'undefined')){
				hitAreas.remove(item);
				item.destroy();
			}
		});		
		
		status = 'hiding';
		charx.body.velocity.y = 50;		
		scoreText.text = parseInt(scoreText.text) + parseInt(gameSettings.pointsPerHit);
		this.winConCheck();
	},
	winConCheck: function(){
		if(parseInt(scoreText.text) >= parseInt(gameSettings.winWhen)){
			gameActive = false;
			this.onWin();
			board.alpha = 1;
			againButton.alpha = 1;	
			messageText.alpha = 1;	
			risers = [];
			stage.forEach(function(mole) {		
				if(!(typeof mole.moleNo === 'undefined')){
					mole.moves = false;
					mole.position.y = mole.startPositionY;
					mole.body.velocity.y = 0;
					mole.status = 'none';
					mole.moves = true;					
				}
			});			
			messageText.text = "You have won \n" + gameSettings.pointsWon + " points!";
			grats = game.add.sprite(window.innerWidth/7.4,window.innerHeight / 3, 'congratulations');

		}
	},
	onCurtainClicked: function(charx){

	},
	onWin: function(){
		//Jepoy do your thing
	}
};

game.state.add('Boot', BasicGame.Boot);
game.state.start('Boot');

</script>

</body>
</html>